<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Debug Dashboard</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; max-height: 300px; }
    </style>
</head>
<body>
    <h1>Dashboard Debug</h1>

    <div class="section">
        <h2>1. Fetch Data</h2>
        <button onclick="testFetch()">Test Fetch</button>
        <div id="fetchStatus"></div>
    </div>

    <div class="section">
        <h2>2. Transform Data</h2>
        <button onclick="testTransform()">Test Transform</button>
        <div id="transformStatus"></div>
        <pre id="transformOutput"></pre>
    </div>

    <div class="section">
        <h2>3. Check Chart Data</h2>
        <button onclick="testChartData()">Test Chart Data</button>
        <div id="chartStatus"></div>
        <pre id="chartOutput"></pre>
    </div>

    <script>
        let rawData = null;
        let transformedData = null;

        async function testFetch() {
            try {
                const response = await fetch('../data/processed/dashboard_data.json');
                document.getElementById('fetchStatus').innerHTML = `✓ Status: ${response.status} ${response.statusText}`;
                rawData = await response.json();
                console.log('Raw data:', rawData);
                document.getElementById('fetchStatus').innerHTML += '<br>✓ Data loaded successfully';
            } catch (error) {
                document.getElementById('fetchStatus').innerHTML = `✗ Error: ${error.message}`;
                console.error('Fetch error:', error);
            }
        }

        function transformData(data) {
            const { periods, values } = data;
            const transformed = [];

            periods.forEach((period, idx) => {
                const dataPoint = {
                    month_label: period
                };

                Object.keys(values).forEach(metric => {
                    const value = values[metric][idx];
                    const fieldMap = {
                        'GMV': 'gmv',
                        'Funded Amount': 'funded_amount',
                        'Avg Days Outstanding': 'avg_days_outstanding',
                        '# Invoices': 'num_invoices',
                        '# Boxes': 'num_boxes',
                        '% GMV Insured': 'gmv_insured_pct',
                        'Arrangement Fees': 'arrangement_fees',
                        'Logistic Fees': 'logistic_fees',
                        'Logistic Costs': 'logistic_costs',
                        'Cargo Insurance Fees': 'cargo_insurance_fees',
                        'Cargo Insurance Costs': 'cargo_insurance_costs',
                        'Accrued Interests': 'accrued_interests',
                        'Cost of Funds (Accrued)': 'cost_of_funds_accrued',
                        'Docs Management Fees': 'docs_management_fees',
                        'Costs of Docs Delivery': 'costs_docs_delivery',
                        'Warehouse Destination Fees': 'handling_warehouse_fees',
                        'Warehouse Destination Costs': 'handling_warehouse_costs',
                        'Avg Portfolio Outstanding': 'avg_portfolio_outstanding',
                        'Cash Drag': 'cash_drag',
                        'exch_rate': 'usd_eur_rate_eom'
                    };

                    const fieldName = fieldMap[metric] || metric.toLowerCase().replace(/ /g, '_');
                    dataPoint[fieldName] = value;
                });

                transformed.push(dataPoint);
            });

            return transformed;
        }

        async function testTransform() {
            if (!rawData) {
                await testFetch();
            }

            try {
                transformedData = transformData(rawData);
                document.getElementById('transformStatus').innerHTML = `✓ Transformed ${transformedData.length} records`;
                document.getElementById('transformOutput').textContent = JSON.stringify(transformedData.slice(0, 2), null, 2);
                console.log('Transformed data:', transformedData);
            } catch (error) {
                document.getElementById('transformStatus').innerHTML = `✗ Error: ${error.message}`;
                console.error('Transform error:', error);
            }
        }

        async function testChartData() {
            if (!transformedData) {
                await testTransform();
            }

            try {
                const chartData = {
                    labels: transformedData.map(d => d.month_label),
                    gmv: transformedData.map(d => d.gmv),
                    funded: transformedData.map(d => d.funded_amount),
                    invoices: transformedData.map(d => d.num_invoices),
                    boxes: transformedData.map(d => d.num_boxes)
                };

                document.getElementById('chartStatus').innerHTML = '✓ Chart data prepared';
                document.getElementById('chartOutput').textContent = JSON.stringify(chartData, null, 2);
                console.log('Chart data:', chartData);
            } catch (error) {
                document.getElementById('chartStatus').innerHTML = `✗ Error: ${error.message}`;
                console.error('Chart data error:', error);
            }
        }

        // Auto-run tests
        window.addEventListener('load', async () => {
            await testFetch();
            await testTransform();
            await testChartData();
        });
    </script>
</body>
</html>